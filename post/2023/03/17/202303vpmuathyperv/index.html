<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>Windows 11のHyper-V上仮想マシンでPMUを利用する方法 - 気まぐれ気紛れ草紙</title><style type=text/css>img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0 .07em !important;vertical-align:-.1em !important;background:0 0 !important;padding:0 !important}</style><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.css type=text/css media=all><link rel=stylesheet href=/css/custom.css type=text/css media=all><link rel=stylesheet href=/css/syntax.css type=text/css media=all><link rel=stylesheet href=/css/toc.css type=text/css media=all><meta property="og:url" content="https://blog.rkarsnk.jp/post/2023/03/17/202303vpmuathyperv/"><meta property="og:site_name" content="気まぐれ気紛れ草紙"><meta property="og:title" content="Windows 11のHyper-V上仮想マシンでPMUを利用する方法"><meta property="og:description" content="はじめに 先日，Twitterにて @KuniSuzaki さんと，WSL2のLinuxやVM上でパフォーマンスカウンタ(PMU)を利用する方法についてツイートのやりとりをした．その際，Hyper-V上の仮想マシンでPMUを利用する方法について調べたので整理することにした．"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-03-17T16:51:14+09:00"><meta property="article:modified_time" content="2023-03-17T16:51:14+09:00"><meta property="article:tag" content="VM"><meta property="article:tag" content="Hyper-V"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows 11のHyper-V上仮想マシンでPMUを利用する方法"><meta name=twitter:description content="はじめに 先日，Twitterにて @KuniSuzaki さんと，WSL2のLinuxやVM上でパフォーマンスカウンタ(PMU)を利用する方法についてツイートのやりとりをした．その際，Hyper-V上の仮想マシンでPMUを利用する方法について調べたので整理することにした．"></head><body class=two-column><a href=#content>Skip to content</a><div class=wrapper><header role=banner class="banner widgets columns-1"><a href=/ rel=home><h1 class=site>気まぐれ気紛れ草紙</h1><p></p></a><nav role=navigation aria-label="Primary Navigation"><ul class=menu><li class=menu-item><a class=menu__link href=/>Home</a></li><li class=menu-item><a class=menu__link href=/about>About</a></li></ul><select onchange="location.href=value"><option value=/ class="menu-item menu-item-type-custom menu-item-object-custom">Home</option><option value=/about class="menu-item menu-item-type-custom menu-item-object-custom">About</option></select></nav></header><div id=content class=content><main role=main><article role=article class="post type-post format-standard hentry"><header class=post-header><h1>Windows 11のHyper-V上仮想マシンでPMUを利用する方法</h1><div class=post-details><a rel=bookmark><time datetime=2023-03-17T317:451:146>2023-03-17</time>
</a><span style=float:right><div id=fb-root style=height:100%></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v3.2"></script><div class=fb-share-button data-href=https://blog.rkarsnk.jp/post/2023/03/17/202303vpmuathyperv/ data-layout=button_count data-size=small><a target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.rkarsnk.jp%2fpost%2f2023%2f03%2f17%2f202303vpmuathyperv%2f" class=fb-xfbml-parse-ignore>Share</a></div>&nbsp;
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-text="Windows 11のHyper-V上仮想マシンでPMUを利用する方法" data-url=https://blog.rkarsnk.jp/post/2023/03/17/202303vpmuathyperv/ data-show-count=false>Tweet</a>
<script async src=https://platform.twitter.com/widgets.js></script>&nbsp;
<a href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fblog.rkarsnk.jp%2fpost%2f2023%2f03%2f17%2f202303vpmuathyperv%2f&title=Windows%2011%e3%81%aeHyper-V%e4%b8%8a%e4%bb%ae%e6%83%b3%e3%83%9e%e3%82%b7%e3%83%b3%e3%81%a7PMU%e3%82%92%e5%88%a9%e7%94%a8%e3%81%99%e3%82%8b%e6%96%b9%e6%b3%95" class=hatena-bookmark-button data-hatena-bookmark-layout=basic-counter><img src=https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png width=20 height=20 style=border:none>
</a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></span></div></header><div class=post-content><h1 id=はじめに>はじめに</h1><p>先日，Twitterにて <code>@KuniSuzaki</code> さんと，WSL2のLinuxやVM上でパフォーマンスカウンタ(PMU)を利用する方法についてツイートのやりとりをした．その際，Hyper-V上の仮想マシンでPMUを利用する方法について調べたので整理することにした．</p><div class=toc-box><div class=toc-label>目次</div><div class=toc-chapter><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#hyper-vでpmuを利用するための要件>Hyper-VでPMUを利用するための要件</a></li><li><a href=#仮想マシンの準備>仮想マシンの準備</a></li><li><a href=#pmuを使用する準備>PMUを使用する準備</a></li><li><a href=#動作確認>動作確認</a></li><li><a href=#おわりに>おわりに</a></li></ul></nav></div></div><h1 id=hyper-vでpmuを利用するための要件>Hyper-VでPMUを利用するための要件</h1><p>Hyper-Vの仮想マシンでPMUを利用するためには，以下の要件をみたす必要がある．</p><blockquote><p>The virtual machine generation must be 9.1 or higher.</p><p><a href=https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/performance-monitoring-hardware#enabling-performance-monitoring-components-in-a-virtual-machine title="Microsoft Learn">Enabling performance monitoring components in a virtual machine</a></p></blockquote><p>自ホストに導入されているHyper-VがVersion 9.1以上の仮想マシンをサポートしているかどうかは，PowerShellの<code>Get-VMSupportVersion</code>コマンドで確認できる．Windows 11での例を以下に示す．</p><pre tabindex=0><code>&gt; Get-VMHostSupportedVersion

Name                                                  Version IsDefault
----                                                  ------- ---------
Microsoft Windows 10 Anniversary Update/Server 2016   8.0     False
Microsoft Windows 10 Creators Update                  8.1     False
Microsoft Windows 10 Fall Creators Update/Server 1709 8.2     False
Microsoft Windows 10 April 2018 Update/Server 1803    8.3     False
Microsoft Windows 10 October 2018 Update/Server 2019  9.0     False
Microsoft Windows 10 May 2019 Update/Server 1903      9.1     False
Microsoft Windows 10 May 2020 Update/Server 2004      9.2     False
Microsoft Windows 10 (Manganese)                      9.3     False
Microsoft Windows Server 2022                         10.0    False
Microsoft ホスト OS (コバルト+)                       10.5    False
Microsoft Windows 11 (22H2)                           11.0    True
</code></pre><p>上の出力結果から，このホストでは，Version 9.1以上の仮想マシンに対応しており，Version 11.0が有効になっていることが確認できる．</p><h1 id=仮想マシンの準備>仮想マシンの準備</h1><p>Hyper-V マネージャを使用して，仮想マシンを作成する．
図1のように，<code>PMUtest</code> という名前で仮想マシンを作成した．仮想マシンの構成バージョンは11.0となっている．この構成バージョンというのは，<code>Get-VMHostSupportedVersion</code>で表示されるVersionを指しており，11.0であるためPMUを利用するための条件を満たしている．</p><p>また，図2の概要にある世代というのは，LegacyBIOSから起動するか，UEFI BIOSから起動するかを指しており，UEFI BIOSから起動する世代2の仮想マシンとなっている．</p><figure><img src=/images/202303vpmuhyperv/vpmu01.png width=900><figcaption><h4>図1 仮想マシン一覧</h4></figcaption></figure><figure><img src=/images/202303vpmuhyperv/vpmu02.png width=900><figcaption><h4>図2 PMUtest概要</h4></figcaption></figure><p>同様の情報は，以下のPowerShellコマンドでも取得できる．</p><pre tabindex=0><code>&gt; Get-VM PMUtest | Format-List Version
Version : 11.0
</code></pre><p>また，明示的に構成バージョンを指定した仮想マシンを作成したい場合は，PowerShellコマンドで以下のコマンドを実行するとよい．</p><pre tabindex=0><code>&gt; New-VM -Name &#34;vmname&#34; -Version 11.0
</code></pre><p>仮想マシンを作成した後は，任意のLinuxディストリをインストールする．ここではCentOS 9 Streamを選択した．CentOS 9 Streamのインストールについては説明を省略する．</p><h1 id=pmuを使用する準備>PMUを使用する準備</h1><p>作成した仮想マシンは，デフォルトの状態ではPMUの使用が無効になっている．有効にするために以下のPowerShellコマンドを実行する．</p><pre tabindex=0><code>&gt; Set-VMProcessor PMUTest -Perfmon @(&#34;pmu&#34;)
</code></pre><p>なお，PMUの使用を無効にする場合は，以下のPowerShellコマンドを実行する．</p><pre tabindex=0><code>&gt; Set-VMProcessor PMUTest -Perfmon @(&#34;&#34;)
</code></pre><p>設定が有効になっているか確認する場合は，以下のコマンドを実行する．</p><pre tabindex=0><code>&gt; Get-VMProcessor PMUtest | Format-List EnablePerfmon*
EnablePerfmonPmu     : True     ←PMUが有効になっている．
EnablePerfmonArchPmu : False
EnablePerfmonLbr     : False
EnablePerfmonPebs    : False
EnablePerfmonIpt     : False
</code></pre><h1 id=動作確認>動作確認</h1><p>PMU無効時は図3のように <code>&lt;not supported></code> と表示される．PMUを有効にすると，図4のようにパフォーマンスカウンタから取得した値が表示される．</p><figure><img src=/images/202303vpmuhyperv/perf01.png width=900><figcaption><h4>図3 PMU無効時の実行結果</h4></figcaption></figure><figure><img src=/images/202303vpmuhyperv/perf02.png width=900><figcaption><h4>図4 PMU有効時の実行結果</h4></figcaption></figure><h1 id=おわりに>おわりに</h1><p>本記事では，Hyper-V上の仮想マシンでPMUを利用する方法について，簡単にまとめた．</p><p>以下に，本記事を書くにあたり参考にしたウェブページのリンクを記載する．</p><ul><li><p><a href=https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/performance-monitoring-hardware#enabling-performance-monitoring-components-in-a-virtual-machine>Enabling performance monitoring components in a virtual machine (Microsoft Learn)</a></p></li><li><p><a href=https://taityo-diary.hatenablog.jp/entry/2022/03/27/071025>Hyper-V の仮想マシンで perf の &ldquo;not supported&rdquo; な項目を出力できるようにする (ぱと隊長日誌)</a></p></li><li><p><a href=https://www.intel.com/content/www/us/en/docs/vtune-profiler/cookbook/2023-0/configuring-hypervvm-for-hw-hotspots-analysis.html>Configuring a Hyper-V* Virtual Machine for Hardware-Based Hotspots Analysis (Intel VTune Profiler Performance Analysis Cookbook)</a></p></li></ul></div><footer class=post-footer><span class=post-categories><a href=https://blog.rkarsnk.jp/categories/hyper-v/>Hyper-V</a>&emsp;
</span><span class=post-tags><a href=https://blog.rkarsnk.jp/tags/hyper-v/>Hyper-V</a>&emsp;
<a href=https://blog.rkarsnk.jp/tags/vm/>VM</a>&emsp;</span></footer><table cellspacing=15 style=width:100%;border:none><tr><td style=text-align:center;border:none;padding:0></td><td style=text-align:center;border:none;padding:0></td></tr></table></article><script type=application/javascript src=/js/code.js></script><link rel=stylesheet href=/css/code.css type=text/css media=all><nav class="navigation post-navigation" role=navigation><div class=nav-links><div class=nav-previous><a class=previous href=https://blog.rkarsnk.jp/post/2023/03/13/202302covid19/>コロナウィルスに感染した記録</a></div><div class=nav-next><a class=next href=https://blog.rkarsnk.jp/post/2023/05/14/202305debianlivebuild/>Debian Live Build を使用したカスタムインストールISOの作成</a></div></div></nav><section></section></main><div class="sidebar1 widgets columns-1"><aside></aside><aside class="widget widget_categories"><h2>カテゴリ</h2><ul class=widget__list><li class="cat-item cat-item-2"><a href=https://blog.rkarsnk.jp/categories/diary/>Diary (2)</a></li><li class="cat-item cat-item-2"><a href=https://blog.rkarsnk.jp/categories/hyper-v/>Hyper-V (1)</a></li><li class="cat-item cat-item-2"><a href=https://blog.rkarsnk.jp/categories/linux/>Linux (1)</a></li><li class="cat-item cat-item-2"><a href=https://blog.rkarsnk.jp/categories/%E6%8A%80%E8%A1%93%E7%B3%BB/>技術系 (1)</a></li><li class="cat-item cat-item-2"><a href=https://blog.rkarsnk.jp/categories/%E6%97%A5%E8%A8%98/>日記 (1)</a></li></ul></aside><aside class="widget widget_tag_cloud"><h2>タグ</h2><div class=tagcloud><a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/apple/ title=apple style=font-size:12pt>Apple</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/covid-19/ title=covid-19 style=font-size:12pt>COVID-19</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/debian/ title=debian style=font-size:12pt>Debian</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/hyper-v/ title=hyper-v style=font-size:12pt>Hyper-V</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/linux/ title=linux style=font-size:12pt>Linux</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/live-build/ title="live build" style=font-size:12pt>Live Build</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/ovmf/ title=ovmf style=font-size:12pt>OVMF</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/proxmox/ title=proxmox style=font-size:12pt>Proxmox</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/uefi/ title=uefi style=font-size:12pt>UEFI</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/vm/ title=vm style=font-size:12pt>VM</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/%E3%82%B3%E3%83%AD%E3%83%8A%E3%82%A6%E3%82%A3%E3%83%AB%E3%82%B9/ title=コロナウィルス style=font-size:12pt>コロナウィルス</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/%E3%82%B3%E3%83%AD%E3%83%8A%E8%87%AA%E5%AE%85%E7%99%82%E9%A4%8A/ title=コロナ自宅療養 style=font-size:12pt>コロナ自宅療養</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/%E6%A2%85%E7%94%B0/ title=梅田 style=font-size:12pt>梅田</a>&emsp;<a class=tag-cloud-link href=https://blog.rkarsnk.jp/tags/%E8%87%AA%E4%BD%9Cos/ title=自作os style=font-size:12pt>自作OS</a>&emsp;</div></aside><aside class="widget widget_recent_entries"><h2>最近の投稿</h2><ul><li><a href=/post/2025/08/10/20250810_pve01/>第1回 Proxmox VE 9.0 : 導入</a></li><li><a href=/post/2025/07/26/20250726_appleumeda/>Apple梅田オープン!!</a></li><li><a href=/post/2023/05/14/202305debianlivebuild/>Debian Live Build を使用したカスタムインストールISOの作成</a></li><li><a href=/post/2023/03/17/202303vpmuathyperv/>Windows 11のHyper-V上仮想マシンでPMUを利用する方法</a></li><li><a href=/post/2023/03/13/202302covid19/>コロナウィルスに感染した記録</a></li><li><a href=/post/2021/12/10/debugefiapp/>UEFIアプリケーションをデバッグする</a></li></ul></aside><aside class="widget widget_archive"><h2>アーカイブ</h2><ul><li><a href=https://blog.rkarsnk.jp/archives/2021/12/>2021/12 (1)</a></li><li><a href=https://blog.rkarsnk.jp/archives/2023/03/>2023/03 (2)</a></li><li><a href=https://blog.rkarsnk.jp/archives/2023/05/>2023/05 (1)</a></li><li><a href=https://blog.rkarsnk.jp/archives/2025/07/>2025/07 (1)</a></li><li><a href=https://blog.rkarsnk.jp/archives/2025/08/>2025/08 (1)</a></li></ul></aside></div></div></div><footer role=contentinfo class="document-footer contentinfo widgets columns-1"><aside class="widget widget_text"><div class=textwidget><p>© 気まぐれ気紛れ草紙 / Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/tosi29/inkblotty target=_blank>Inkblotty</a></p></div></aside></footer></div></body></html>